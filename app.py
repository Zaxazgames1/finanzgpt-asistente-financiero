import streamlit as st
import time

# Importaciones de clases
from models.empresa import Empresa
from services.analizador_financiero import AnalizadorFinanciero
from services.nlp_service import NLPService
from utils.formatters import Formatters
from utils.validators import Validators
from ui.styles import StylesUI
from ui.chat_ui import ChatUI
from ui.form_ui import FormUI
from ui.results_ui import ResultsUI

# Clase principal de la aplicaci√≥n
class FinanzGPTApp:
    """
    Clase principal que coordina la aplicaci√≥n FinanzGPT con dise√±o tipo Gemini.
    """
    def __init__(self):
        """
        Inicializa la aplicaci√≥n FinanzGPT.
        """
        # Configuraci√≥n de la p√°gina
        st.set_page_config(
            page_title="FinanzGPT - Asistente Financiero",
            page_icon="ü§ñ",
            layout="wide",
            initial_sidebar_state="expanded"
        )
        
        # Inicializar servicios
        self.nlp_service = NLPService()
        self.analizador_financiero = AnalizadorFinanciero()
        
        # Inicializar utilidades
        self.formatters = Formatters()
        self.validators = Validators()
        
        # Inicializar componentes de UI
        self.styles_ui = StylesUI()
        self.chat_ui = ChatUI(self.nlp_service, self.formatters)
        self.form_ui = FormUI(self.analizador_financiero, self.validators)
        self.results_ui = ResultsUI(self.formatters)
        
        # Inicializar estado de la aplicaci√≥n
        if 'page_view' not in st.session_state:
            st.session_state.page_view = "chat"
        
        if 'datos_empresa' not in st.session_state:
            st.session_state.datos_empresa = None
        
        # Aplicar estilos CSS tipo Gemini
        st.markdown(self.styles_ui.get_css(), unsafe_allow_html=True)
    
    def render_sidebar(self):
        """
        Renderiza la barra lateral estilo Gemini.
        """
        with st.sidebar:
            # Logo y t√≠tulo
            st.markdown("""
                <div style="padding: 1.5rem 0; text-align: center;">
                    <div style="font-size: 1.25rem; font-weight: 500; color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <span style="background: linear-gradient(135deg, #FA8B00, #8B00FA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.5rem;">ü§ñ</span>
                        FinanzGPT
                    </div>
                    <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.25rem;">
                        2.0 Flash
                    </div>
                </div>
            """, unsafe_allow_html=True)
            
            # Nueva conversaci√≥n
            if st.button("‚ûï Nueva conversaci√≥n", use_container_width=True):
                if 'chat_history' in st.session_state:
                    st.session_state.chat_history = []
                st.rerun()
            
            # Navegaci√≥n principal
            st.markdown("""
                <div style="margin: 1.5rem 0; padding: 0 1rem;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                        Navegaci√≥n
                    </div>
                </div>
            """, unsafe_allow_html=True)
            
            current_page = st.session_state.page_view
            
            # Chat
            if st.button("üí¨ Chat", use_container_width=True, disabled=(current_page == "chat")):
                st.session_state.page_view = "chat"
                st.rerun()
            
            # Descubrir Gems
            if st.button("üåü Descubrir Gems", use_container_width=True, disabled=(current_page == "gems")):
                st.toast("Funci√≥n en desarrollo", icon="üöß")
            
            # Historial
            st.markdown("""
                <div style="margin: 1.5rem 0; padding: 0 1rem;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                        Reciente
                    </div>
                </div>
            """, unsafe_allow_html=True)
            
            # Conversaciones recientes
            if st.session_state.datos_empresa:
                empresa_nombre = st.session_state.datos_empresa.get('resultados', {}).get('nombre', 'Empresa')
                with st.container():
                    if st.button(f"üè¢ {empresa_nombre}", use_container_width=True):
                        st.session_state.page_view = "results"
                        st.rerun()
            
            # Crear GUI con texto reflejado
            if st.button("üìù Interfaz Gemini en Python...", use_container_width=True, disabled=(current_page == "form")):
                st.session_state.page_view = "form"
                st.rerun()
            
            if st.button("üìë Crear GUI con texto reflejado", use_container_width=True):
                st.toast("Creando interfaz tipo Gemini...", icon="‚ú®")
            
            # Espacio flexible
            st.markdown("""
                <div style="flex: 1;"></div>
            """, unsafe_allow_html=True)
            
            # Footer del sidebar
            st.markdown("""
                <hr style="margin: 2rem 0 1rem 0; border: none; border-top: 1px solid var(--border-color);">
                <div style="padding: 0 1rem 2rem 1rem;">
                    <button id="settings-btn" style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); background: none; border: none; text-decoration: none; font-size: 0.875rem; padding: 0.5rem 0; cursor: pointer; width: 100%; text-align: left;">
                        ‚öôÔ∏è Ajustes y ayuda
                    </button>
                </div>
            """, unsafe_allow_html=True)
            
            # Bot√≥n de Ajustes y ayuda
            if st.button("‚öôÔ∏è Ajustes y ayuda", use_container_width=True):
                st.toast("Configuraci√≥n en desarrollo", icon="‚öôÔ∏è")
            
            # Bot√≥n de Acerca de
            if st.button("‚ÑπÔ∏è Acerca de FinanzGPT", use_container_width=True, disabled=(current_page == "about")):
                st.session_state.page_view = "about"
                st.rerun()
    
    def render_header(self):
        """
        Header minimalista o vac√≠o para mantener el estilo Gemini.
        """
        pass
    
    def render_welcome(self):
        """
        Renderiza la pantalla de bienvenida estilo Gemini.
        """
        st.markdown("""
            <div class="welcome-container">
                <div class="welcome-icon">ü§ñ</div>
                <h1 class="welcome-title">Hola, Johan Sebasti√°n</h1>
                <p class="welcome-subtitle">
                    ¬øC√≥mo puedo ayudarte con tus finanzas empresariales hoy?
                </p>
                
                <div style="max-width: 600px; margin: 3rem auto;">
                    <div class="suggestions-title">Sugerencias para comenzar:</div>
                    <div class="suggestion-chips">
                        <div class="suggestion-chip">Analiza mi situaci√≥n financiera</div>
                        <div class="suggestion-chip">¬øC√≥mo mejorar la rentabilidad?</div>
                        <div class="suggestion-chip">Estrategias de crecimiento</div>
                        <div class="suggestion-chip">Reducir deuda empresarial</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 3rem;">
                    <button class="deep-research-button" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        üîç Deep Research
                    </button>
                    <button class="canvas-button">
                        üìä Canvas
                    </button>
                </div>
            </div>
        """, unsafe_allow_html=True)
    
    def render_about(self):
        """
        Renderiza la p√°gina Acerca de con informaci√≥n de desarrolladores y tecnolog√≠a.
        """
        # En lugar de usar HTML raw, usar componentes de Streamlit
        st.markdown("# ü§ñ FinanzGPT")
        st.markdown("*Asistente Financiero Inteligente potenciado por IA de √∫ltima generaci√≥n*")
        
        st.markdown("---")
        
        # Secci√≥n de tecnolog√≠a
        st.markdown("## üß† Google Gemini 2.0 Flash")
        st.markdown("### Motor de Inteligencia Artificial")
        
        st.info("""
        FinanzGPT utiliza **Google Gemini 2.0 Flash**, uno de los modelos de IA m√°s avanzados del mercado. 
        Esta tecnolog√≠a de vanguardia permite:
        """)
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("‚úÖ Comprensi√≥n profunda del contexto financiero")
            st.markdown("‚úÖ Respuestas en espa√±ol natural y fluido")
            st.markdown("‚úÖ An√°lisis en tiempo real con alta precisi√≥n")
        
        with col2:
            st.markdown("‚úÖ Generaci√≥n de recomendaciones personalizadas")
            st.markdown("‚úÖ Procesamiento de datos financieros complejos")
            st.markdown("‚úÖ Aprendizaje continuo y mejora constante")
        
        st.markdown("---")
        
        # Arquitectura y tecnolog√≠a
        st.markdown("## ‚ö° Arquitectura y Tecnolog√≠a")
        st.markdown("### Stack tecnol√≥gico de vanguardia")
        
        st.info("FinanzGPT est√° construido con las mejores tecnolog√≠as disponibles:")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("üêç **Python 3.10+** - Lenguaje principal")
            st.markdown("üöÄ **Streamlit** - Framework web moderno")
            st.markdown("ü§ñ **Gemini API** - Motor de IA")
        
        with col2:
            st.markdown("üìä **Matplotlib** - Visualizaci√≥n de datos")
            st.markdown("üîç **NLTK & spaCy** - Procesamiento de lenguaje")
            st.markdown("üíæ **NumPy & Pandas** - An√°lisis de datos")
        
        st.markdown("---")
        
        # Equipo de desarrollo
        st.markdown("## üë®‚Äçüíª Equipo de Desarrollo")
        
        col1, col2 = st.columns(2)
        
        with col1:
            with st.container():
                st.markdown("### üéØ Julian Lara")
                st.markdown("**Full Stack Developer & AI Engineer**")
                st.markdown("""
                Especialista en inteligencia artificial y arquitectura de software. 
                Experto en integraci√≥n de modelos de IA y desarrollo de interfaces intuitivas.
                """)
        
        with col2:
            with st.container():
                st.markdown("### üí° Johan Rojas")
                st.markdown("**Lead Developer & UX Designer**")
                st.markdown("""
                L√≠der en desarrollo de aplicaciones web y dise√±o de experiencia de usuario. 
                Experto en crear interfaces elegantes y funcionales.
                """)
        
        st.markdown("---")
        
        # Capacidades
        st.markdown("## üéØ ¬øQu√© puede hacer FinanzGPT?")
        st.markdown("### Capacidades y funcionalidades")
        
        st.info("FinanzGPT es un asistente financiero completo que puede:")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("üìä Analizar indicadores financieros clave (ROA, ROE, liquidez)")
            st.markdown("üí° Generar recomendaciones personalizadas para tu empresa")
            st.markdown("üìà Crear visualizaciones interactivas de datos")
        
        with col2:
            st.markdown("üéØ Dise√±ar estrategias de crecimiento")
            st.markdown("üí¨ Responder preguntas complejas sobre finanzas")
            st.markdown("üîÆ Proyectar escenarios futuros")
        
        st.markdown("---")
        
        # Secci√≥n de contacto
        st.markdown("## üìû ¬øInteresado en nuestros servicios?")
        st.info("""
        Desarrollamos chatbots inteligentes personalizados para empresas. 
        Transformamos tu servicio al cliente con IA de √∫ltima generaci√≥n.
        """)
        
        if st.button("üìß Cont√°ctanos para tu proyecto", type="primary", use_container_width=True):
            st.success("¬°Gracias por tu inter√©s! Nos pondremos en contacto pronto.")
    
    def run(self):
        """
        Ejecuta la aplicaci√≥n principal con dise√±o tipo Gemini.
        """
        # Renderizar header (vac√≠o o minimalista)
        self.render_header()
        
        # Renderizar sidebar
        self.render_sidebar()
        
        # Renderizar la vista correspondiente
        if st.session_state.page_view == "chat":
            self.chat_ui.renderizar_chat(st.session_state.datos_empresa)
        
        elif st.session_state.page_view == "form":
            datos_procesados = self.form_ui.renderizar_formulario()
            if datos_procesados:
                st.session_state.datos_empresa = datos_procesados
                st.session_state.page_view = "results"
                st.rerun()
        
        elif st.session_state.page_view == "results":
            if st.session_state.datos_empresa:
                self.results_ui.renderizar_resultados(st.session_state.datos_empresa)
            else:
                st.warning("‚ö†Ô∏è No hay datos para mostrar. Por favor, ingresa primero los datos de tu empresa.")
                if st.button("üìù Ir a Datos"):
                    st.session_state.page_view = "form"
                    st.rerun()
        
        elif st.session_state.page_view == "about":
            self.render_about()
        
        else:
            self.render_welcome()

# C√≥digo principal
if __name__ == "__main__":
    app = FinanzGPTApp()
    app.run()